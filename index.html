<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚ªã‚»ãƒ­ã‚²ãƒ¼ãƒ ï¼ˆAIå¯¾æˆ¦ï¼‰</title>

    <!-- ã‚ªã‚»ãƒ­ç›¤ã¨çŸ³ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š -->
    <style>
      table {
          border-collapse: collapse;  /* æ ã‚’1æœ¬ã«è¦‹ã›ã‚‹ */
      }
      td {
          width: 50px;
          height: 50px;
          border: 1px solid black;
          text-align: center;
          vertical-align: middle;
          font-size: 24px;
          background-color: green;  /* ã‚ªã‚»ãƒ­ç›¤ã®èƒŒæ™¯è‰² */
          cursor: pointer;
          position: relative;  /* çŸ³(div)ã‚’ä¸­å¤®ã«é…ç½®ã™ã‚‹ãŸã‚ã« relative */
      }

      /* çŸ³ï¼ˆé»’ã¨ç™½ï¼‰ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
      .black, .white {
          width: 40px;
          height: 40px;
          border-radius: 50%;  /* ä¸¸ã„çŸ³ã«ã™ã‚‹ */
          position: absolute;
          top: 5px;
          left: 5px;
      }

      /* é»’çŸ³ */
      .black {
          background-color: black;
      }

      /* ç™½çŸ³ */
      .white {
          background-color: white;
      }
  </style>
</head>
<body>
    <h1>ã‚ªã‚»ãƒ­ã‚²ãƒ¼ãƒ ï¼ˆAIå¯¾æˆ¦ï¼‰</h1>

<!-- ã‚ªã‚»ãƒ­ç›¤(JavaScriptã§æç”») -->
    <table id="board"></table>

    <!-- ç¾åœ¨ã®æ‰‹ç•ªã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé ˜åŸŸ -->
    <div id="status"></div>
    <div id="messages" style="margin: 10px 0; color: red;"></div>

    <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
    <div style="margin-bottom: 10px;">
      <button onclick="resetGame()">ğŸ” ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="endBtn">â›” çµ‚äº†</button>
    </div>

    <!-- åŠ¹æœéŸ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
    <audio id="place-sound" src="{{ url_for('static', filename='othello.wav') }}"></audio>

        <script>
        // DOMã®è¦ç´ ã‚’å–å¾—
        const boardElement = document.getElementById("board");
        const statusElement = document.getElementById("status");
        const messagesElement = document.getElementById("messages");

        // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ•ãƒ©ã‚°
        let gameOver = false;

        // çµ‚äº†å‡¦ç†
        document.getElementById("endBtn").addEventListener("click", () => {
            fetch("/end_game", { method: "POST" })
                .then(() => {
                    window.location.href = "/goodbye";  // çµ‚äº†ãƒšãƒ¼ã‚¸ã¸ç§»å‹•
            });
        });

        // ğŸ” ãƒªã‚»ãƒƒãƒˆå‡¦ç†
        function resetGame() {
            fetch("/reset_game", { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    gameOver = false;
                    renderBoard(data);
                    messagesElement.innerHTML = "";
                    addMessage("ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
                });
        }

        // â›” çµ‚äº†å‡¦ç†
        function endGame() {
            fetch("/end_game", { method: "POST" })
                .then(res => res.json())
                .then(data => {
                    gameOver = true;
                    renderBoard(data);
                    addMessage("ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚");
                });
        }

        // ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®å…±é€šé–¢æ•°
        function addMessage(msg) {
            const p = document.createElement("p");
            p.textContent = msg;
            messagesElement.appendChild(p);
        }

        // ç›¤é¢ã‚’æç”»ã™ã‚‹é–¢æ•°
        function renderBoard(state) {
            boardElement.innerHTML = "";  // ç›¤é¢ã‚’ä¸€æ—¦ã‚¯ãƒªã‚¢
            for (let row = 0; row < 8; row++) {
                const tr = document.createElement("tr");
                for (let col = 0; col < 8; col++) {
                    const td = document.createElement("td");
                    const cell = state.board[row][col];

                    // çŸ³ã‚’ç½®ãé…ç½®ï¼ˆ1: é»’, 2: ç™½ï¼‰
                    if (cell === 1) {
                        const disc = document.createElement("div");
                        disc.className = "black";
                        td.appendChild(disc);
                    } else if (cell === 2) {
                        const disc = document.createElement("div");
                        disc.className = "white";
                        td.appendChild(disc);
                    }

                    // ãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç†
                    td.addEventListener("click", () => {
                        if (!gameOver) placeStone(row, col);
                    });

                    tr.appendChild(td);
                }
                boardElement.appendChild(tr);
            }

            // æ‰‹ç•ªã‚’è¡¨ç¤º
            statusElement.textContent = (state.current_player === 1 ? "é»’ã®ç•ªã§ã™" : "ç™½ã®ç•ªã§ã™");
        }

        // åŠ¹æœéŸ³å†ç”Ÿ
        function playPlaceSound() {
            const sound = document.getElementById("place-sound");
            sound.currentTime = 0;  // å·»ãæˆ»ã—ã¦ã‹ã‚‰å†ç”Ÿ
            sound.play();
        }

        // çŸ³ã‚’ç½®ããŸã‚ã®ã‚µãƒ¼ãƒãƒ¼é€šä¿¡å‡¦ç†
        function placeStone(row, col) {
            fetch("/place_stone", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ row, col })
            })
            .then(res => res.json())
            .then(data => {
                messagesElement.innerHTML = "";

                if (data.success) {
                    playPlaceSound();  // â†ã“ã“ã§éŸ³ã‚’é³´ã‚‰ã™
                    // â‘  è‡ªåˆ†ã®æ‰‹ã‚’å³æç”»
                    renderBoard(data);
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => addMessage(msg));
                    }

                    gameOver = data.game_over;

                    // â‘¡ AIã®ç•ªãªã‚‰1ç§’å¾…ã£ã¦ã‹ã‚‰AIã®æ‰‹ã‚’å–å¾—
                    if (!gameOver && data.current_player === 2) {
                        const thinking = document.createElement("p");
                        thinking.textContent = "æ€è€ƒä¸­...";
                        messagesElement.appendChild(thinking);

                        setTimeout(() => {
                            fetch("/ai_move", {
                                method: "POST"
                            })
                            .then(res => res.json())
                            .then(aiData => {
                                renderBoard(aiData);
                                playPlaceSound();  // â† AIãŒç½®ã„ãŸã‚ã¨ã«éŸ³ã‚’é³´ã‚‰ã™
                                messagesElement.innerHTML = "";
                                if (aiData.messages && aiData.messages.length > 0) {
                                    aiData.messages.forEach(msg => addMessage(msg));
                                }
                                gameOver = aiData.game_over;
                            });
                        }, 1000);
                    }
                }
            });
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«åˆæœŸçŠ¶æ…‹ã‚’å–å¾—
        function getInitialState() {
            fetch("/get_state")
                .then(res => res.json())
                .then(data => {
                    renderBoard(data);
                });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸçŠ¶æ…‹ã‚’æç”»
        window.onload = getInitialState;
    </script>
</body>
</html>